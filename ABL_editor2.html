<!DOCTYPE html>
<html lang="hr">
<meta name="viewport" content="width=device-width, initial-scale=1">

<head>
<meta charset="utf-8">
<title>Anchor LWW Prototype</title>

<!-- OpenLayers -->
<script src="https://cdn.jsdelivr.net/npm/ol@v10.5.0/dist/ol.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v10.5.0/ol.css">

<!-- Proj4 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.5.0/proj4.js"></script>

<style>
html, body {
  margin: 0;
  padding: 0;
  height: 100vh;
  width: 100vw;
  font-family: system-ui;
}

#map {
  width: 100%;
  height: 100%;
}

.topbar {
  position: absolute;
  top: 10px;
  left: 10px;
  right: 10px;
  background: rgba(255,255,255,0.95);
  padding: 8px;
  border-radius: 10px;
  display: flex;
  gap: 8px;
  z-index: 1000;
}

.topbar select {
  flex: 1;
  padding: 6px;
}

.floating-btn {
  position: absolute;
  right: 15px;
  width: 48px;
  height: 48px;
  border-radius: 50%;
  border: none;
  background: white;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  font-size: 20px;
  z-index: 1000;
}

#locateBtn { bottom: 100px; }
#trackBtn  { bottom: 40px; }

#trackBtn.active {
  background: #2196f3;
  color: white;
}

.toast {
  position: absolute;
  bottom: 160px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,0.8);
  color: white;
  padding: 8px 12px;
  border-radius: 8px;
  font-size: 14px;
  display: none;
  z-index: 2000;
}
</style>
</head>

<body>

<div id="map"></div>

<div class="topbar">
  <select id="layerSelect"></select>
  <select id="attributeSelect"></select>
</div>

<button class="floating-btn" id="locateBtn">üìç</button>
<button class="floating-btn" id="trackBtn">üõ∞</button>

<div class="toast" id="toast"></div>

<script>

// ================== PROJECTION ==================

proj4.defs('EPSG:3765',
  '+proj=tmerc +lat_0=0 +lon_0=16.5 +k=0.9999 +x_0=500000 +y_0=0 ' +
  '+ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs'
);
ol.proj.proj4.register(proj4);

const htrs96 = ol.proj.get('EPSG:3765');

// ================== CONFIG ==================

const APP_CONFIG = {
  minEditZoom: 18,
  layers: {
    buildings: {
      label: "Buildings",
      attributes: {
        height: { type: "number" },
        status: { type: "enum", values: ["planned", "existing", "demolished"] }
      }
    }
  }
};

// ================== MAP ==================

const DOF = new ol.layer.Tile({
  source: new ol.source.TileWMS({
    url: 'https://geoportal.dgu.hr/services/inspire/orthophoto_lidar_2022_2023/wms',
    params: { 'LAYERS': 'OI.OrthoimageCoverage', 'TILED': true }
  })
});

const gpsSource = new ol.source.Vector();
const gpsLayer = new ol.layer.Vector({ source: gpsSource });

const map = new ol.Map({
  target: 'map',
  layers: [DOF, gpsLayer],
  view: new ol.View({
    projection: htrs96,
    center: [500000, 5070000], // Zagreb area
    zoom: 16
  })
});

// ================== GPS ==================

let watchId = null;

function showToast(msg) {
  const t = document.getElementById("toast");
  t.innerText = msg;
  t.style.display = "block";
  setTimeout(() => t.style.display = "none", 2000);
}

function updateGPS(position) {
  const lon = position.coords.longitude;
  const lat = position.coords.latitude;
  const accuracy = position.coords.accuracy;

  const coord = ol.proj.transform(
    [lon, lat],
    'EPSG:4326',
    'EPSG:3765'
  );

  gpsSource.clear();

  const point = new ol.Feature(new ol.geom.Point(coord));
  point.setStyle(new ol.style.Style({
    image: new ol.style.Circle({
      radius: 6,
      fill: new ol.style.Fill({ color: "#2196f3" }),
      stroke: new ol.style.Stroke({ color: "white", width: 2 })
    })
  }));

  const circle = new ol.Feature(
    new ol.geom.Circle(coord, accuracy)
  );
  circle.setStyle(new ol.style.Style({
    fill: new ol.style.Fill({ color: "rgba(33,150,243,0.2)" })
  }));

  gpsSource.addFeature(circle);
  gpsSource.addFeature(point);

  return coord;
}

document.getElementById("locateBtn").onclick = () => {
  navigator.geolocation.getCurrentPosition(
    pos => {
      const coord = updateGPS(pos);
      map.getView().animate({
        center: coord,
        zoom: APP_CONFIG.minEditZoom,
        duration: 500
      });
    },
    () => showToast("GPS failed"),
    { enableHighAccuracy: true }
  );
};

document.getElementById("trackBtn").onclick = function() {
  if (watchId === null) {
    watchId = navigator.geolocation.watchPosition(
      pos => updateGPS(pos),
      () => showToast("GPS failed"),
      { enableHighAccuracy: true, maximumAge: 1000 }
    );
    this.classList.add("active");
  } else {
    navigator.geolocation.clearWatch(watchId);
    watchId = null;
    this.classList.remove("active");
  }
};

</script>
</body>
</html>
