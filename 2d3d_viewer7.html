<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>OL-Cesium Side by Side for GitHub Pages</title>

  <!-- OpenLayers 10.1.0 CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v10.1.0/ol.css" />
  <!-- Cesium CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cesium@latest/Build/Cesium/Widgets/widgets.css" />



<style>
.grid-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    grid-gap: 20px;
    height: 800px
}
</style>




  </head>
<body>
  


<div class="grid-container">
    <div id="map2d"></div>
    <div id="map3d"></div>
</div>


  <!-- OpenLayers 10.1.0 -->
  <script src="https://cdn.jsdelivr.net/npm/ol@v10.1.0/dist/ol.js"></script>
  <!-- CesiumJS -->
  <script src="https://cdn.jsdelivr.net/npm/cesium@latest/Build/Cesium/Cesium.js"></script>
  <!-- OL-Cesium 2.17.0 -->
  <script src="https://cdn.jsdelivr.net/npm/ol-cesium@2.17.0/dist/olcesium.min.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.5.0/proj4.js"></script>

  <script>
    // IMPORTANT: Tell Cesium where to find its assets (workers, widgets, etc.)
    window.CESIUM_BASE_URL = 'https://cdn.jsdelivr.net/npm/cesium@latest/Build/Cesium/';

    // Disable Cesium Ion (no token needed)
    Cesium.Ion.defaultAccessToken = undefined;

 proj4.defs('EPSG:3765','+proj=tmerc +lat_0=0 +lon_0=16.5 +k=0.9999 +x_0=500000 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs');
 ol.proj.proj4.register(proj4);
 var htrs96 = ol.proj.get('EPSG:3765');

 const OSMLayer = new ol.layer.Tile({
            source: new ol.source.OSM()
        });


 var DOFLayer =  new ol.layer.Tile({
            title: 'DOF 2019/20',
            visible: true,
            source: new ol.source.TileWMS({
                url: 'https://geoportal.dgu.hr/services/inspire/orthophoto_2019_2020/wms',
                params: {'LAYERS': 'OI.OrthoimageCoverage', 'TILED': true},
		attributions: `<a href="https://geoportal.dgu.hr/#/menu/podaci-i-servisi">Geoportal Državne geodetske uprave</a>`
            })
        });


  // Shared vector source
  const vectorSource = new ol.source.Vector();

  // Shared vector layer
  const vectorLayer = new ol.layer.Vector({
    source: vectorSource,
    style: new ol.style.Style({
      fill: new ol.style.Fill({ color: 'rgba(255, 100, 50, 0.3)' }),
      stroke: new ol.style.Stroke({ color: '#ff6432', width: 2 }),
    }),
  });


// Buildings

const bldgStyle = new ol.style.Style({
  fill: new ol.style.Fill({
    color: '#eeeeee',
  }),
  stroke: new ol.style.Stroke({
    color: 'rgba(0, 0, 0, 0.7)',
    width: 3,
  }),
});

var bldgSource = new ol.source.Vector({
        format: new ol.format.GeoJSON(),
        url: 'https://hrvojematijevic.github.io/exercises/resources/makarska_zgrade.geojson'
});

var bldgLayer = new ol.layer.Vector({
    source: bldgSource,
    style: bldgStyle
});


// END buildings



    // 1. 2D OpenLayers map
    const map2d = new ol.Map({
      target: 'map2d',
      layers: [DOFLayer, bldgLayer],
	view: new ol.View({
                projection: htrs96,
                center: [476200, 5046300],
                zoom: 10,
         }),

    });



    // 2. OL map for Cesium (3D)
    const map3d = new ol.Map({
      target: 'map3d',
   
        view: new ol.View({
                projection: htrs96,
                center: [476200, 5046300],
                zoom: 10,
         }),
      
    });


  //map2d.addLayer(vectorLayer);
  
  map3d.addLayer(bldgLayer); // ol-cesium will render this in 3D!
  


    // 3. Setup ol-cesium with the 3D OL map
    const ol3d = new olcs.OLCesium({ map: map3d });
    const scene = ol3d.getCesiumScene();

    // Use OpenStreetMap imagery for Cesium (no Ion)
    scene.imageryLayers.removeAll();
    scene.imageryLayers.addImageryProvider(
      new Cesium.OpenStreetMapImageryProvider({
        url: 'https://a.tile.openstreetmap.org/'
      })
    );

    // Enable 3D rendering
    ol3d.setEnabled(true);


  


  // Add draw interaction on 2D map
  const draw = new ol.interaction.Draw({
    source: bldgSource,
    type: 'Polygon', // You can change this to 'Point', 'LineString', etc.
  });

  map2d.addInteraction(draw);


// 4. Sync views between 2D and 3D
    let syncing = false;

    function syncViews(fromMap, toMap) {
      if (syncing) return;
      syncing = true;

      const view = fromMap.getView();
      const center = view.getCenter();
      const zoom = view.getZoom();
      const rotation = view.getRotation();

      const toView = toMap.getView();
      toView.setCenter(center);
      toView.setZoom(zoom);
      toView.setRotation(rotation);

      syncing = false;
    }

    // Sync 2D → 3D
    map2d.getView().on('change:center', () => syncViews(map2d, map3d));
    map2d.getView().on('change:resolution', () => syncViews(map2d, map3d));
    map2d.getView().on('change:rotation', () => syncViews(map2d, map3d));

    // Sync 3D → 2D
    map3d.getView().on('change:center', () => syncViews(map3d, map2d));
    map3d.getView().on('change:resolution', () => syncViews(map3d, map2d));
    map3d.getView().on('change:rotation', () => syncViews(map3d, map2d));





(async function() {
  try {
    //const tileset = await Cesium.Cesium3DTileset.fromUrl('https://tiles-8mb.pages.dev/tileset.json');
    const tileset = await Cesium.Cesium3DTileset.fromUrl('https://tiles2.pages.dev/tileset.json');
  
    tileset.style = new Cesium.Cesium3DTileStyle({
      pointSize: 3,       // increase size to make points more visible
    });

    scene.primitives.add(tileset);

    // Optional: zoom to it
    scene.camera.flyToBoundingSphere(tileset.boundingSphere, { duration: 2 });
  } catch (error) {
    console.error('Failed to load 3D Tileset:', error);
  }
})();


  </script>
</body>
</html>
